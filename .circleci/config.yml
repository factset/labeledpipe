version: 2

node_6: &node_6
  docker:
    - image: node:6@sha256:85a878cb14deb5a5a59944e906d43ef400e182e9fcc81a6beb18907f52309261

node_8: &node_8
  docker:
    - image: node:8@sha256:f10c8218e3f92b513af9120f5eda5fed35b651343f940881d696b958cc16ab43

node_next: &node_next
  docker:
    - image: node:latest@sha256:c00e4cb3acfb2a0c4997ddb0e809cba37f9f6cce43efa9a6e6f7f1a79e094ab5

yarn_latest: &yarn_latest
  steps:
    - checkout
    - restore_cache:
        keys:
          - dependencies_yarn_latest
    - run: curl -o- -L https://yarnpkg.com/install.sh | bash
    - run: yarn install --frozen-lockfile
    - save_cache:
        paths:
          - node_modules
          - ${HOME}/.cache/yarn
        key: dependencies_yarn_latest
    - run: yarn test
    - run: ($(yarn bin)/codecov || echo "Codecov did not collect coverage reports")

jobs:
  node_6_yarn_latest:
    <<: [*node_6, *yarn_latest]
  node_8_yarn_latest:
    <<: [*node_8, *yarn_latest]
  node_next:
    <<: [*node_next, *yarn_latest]
  deliver:
    <<: [*node_8]
    steps:
      - checkout
      - restore_cache:
          keys:
            - dependencies_deliver
      - run: yarn install --frozen-lockfile
      - save_cache:
          paths:
            - node_modules
            - ${HOME}/.cache/yarn
          key: dependencies_deliver
      - run: $(yarn bin)/semantic-release-github
  publish:
    <<: [*node_8]
    steps:
      - checkout
      - restore_cache:
          keys:
            - dependencies_publish
      - run: yarn install --frozen-lockfile
      - save_cache:
          paths:
            - node_modules
            - ${HOME}/.cache/yarn
          key: dependencies_publish
      - run: $(yarn bin)/npm-publish-git-tag

workflows:
  version: 2
  build:
    jobs:
      - node_6_yarn_latest
      - node_8_yarn_latest
      - node_next
      - deliver:
          filters:
            branches:
              only: master
          requires:
          - node_6_yarn_latest
          - node_8_yarn_latest
      - publish:
          filters:
            tags:
              only: /.+/
          requires:
            - deliver
